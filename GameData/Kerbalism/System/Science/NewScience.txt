// ============================================================================
// Temporary tweaking values
// ============================================================================
// Tweaking hints
//
// Put desired scientific value into value, that will
// later be copied onto baseValue. We need to do this because KSP calculates
// the size of an experiment thusly: dataScale * baseValue = size in Mb
//
// In Kerbalism terms...
// baseValue = the scientific value of an experiment (science points)
// dataScale = megabytes per science points
// scienceCap is irrelevant.
// ============================================================================
// My general idea of balancing - Crewed experiments give more science,
// due to ship design complexity and life support factors.
// Unmanned experiments will net less to compensate
// ============================================================================
KERBALISM_EXPERIMENT_VALUES
{
	crewReport
	{
		ECCost = 0.01 							// the light must be on...
		size = 0.46
		value = 3								//nerfed science value slightly, due to another longer crewed experiment being available (5->3), removed atmospheric biome mask.
		duration = 294
	}

	evaReport
	{
		ECCost = 0.02
		size = 0.23							//multiple EVAs required at low tech level for full completion, later on can be done in 1 EVA.
		value = 10								//slightly increased value to compensate (8->10)
		duration = 618						//10 min + duration, removed atmospheric situatons (i'm sorry but astronauts don't EVA inside an atmosphere)
	}

	surfaceSample
	{
		ECCost = 18.62							//massive EC/s for unmanned probes (EVA consumption gets nerfed later in this file)
		SampleMass = 0.012
		size = 986								//large size to account for lab processing time.
		value = 52								//buffed science value due to complexity of landings (40->52), small buff due to biome mask still being present, removed oceanic samples due to dedicated experiment added
		duration = 94							//drilling is probably reasonably quick.
	}

	mysteryGoo
	{
		ECCost = 0.18
		SampleMass = 0.0073
		size = 429								//same as above, massive data scale for lab processing.
		value = 6								// nerfed (13->6), also nuked biome mask (makes no sense that the samples would be different)
		duration = 641
	}

	geigerCounter
	{
		ECCost = 0.005							//all sensors will have very low EC/s consumption
		size = 0.33								//small size, early experiment
		value = 4								//nerfed value (8->4), added biome mask for landed/splashed (makes sense that radiation would be slightly different in different biomes)
		duration = 497							//reasonably short, as it gets unlocked very early.
	}

	mobileMaterialsLab
	{
		ECCost = 0.51
		SampleMass = 0.032
		size = 3084
		value = 64								//value massively buffed (32->64), nuked biome mask (makes no sense that the sampes would be different)
		duration = 14982						//moderate length, 4+ hours.
	}

	temperatureScan
	{
		ECCost = 0.002							//all sensors will have very low EC/s consumption
		size = 0.45								//reasonably small scale, as it's a very early experiment
		value = 3								//nerfed value (8->3) due to it being an early unlock, left biome/situations unchanged
		duration = 138
	}

	barometerScan
	{
		ECCost = 0.39
		size = 8.37
		value = 16								// buffed value (12->16), changed situations to atmo/landed/splashed, biome masks landed/splashed/flying low, made it require atmosphere in all cases. (there's no pressure if there's no atmosphere, i'm sorry)
		duration = 916							//15 minutes+
	}

	seismicScan
	{
		ECCost = 0.0076
		size = 2359
		value = 16								// nerfed value (22-16), left situations/biomes unchanged
		duration = 317248						// first moderately long-term experiment, 2 weeks+ required.
	}

	gravityScan
	{
		ECCost = 0.041
		size = 827
		value = 24								// buffed value due to length, late unlock AND loss of some biome masks. (22->24)
		duration = 1959086						//first properly long experiment, takes 90+ days to complete. Situations unchanged, biomes = landed/splashed only.
	}

	atmosphereAnalysis
	{
		ECCost = 2.84
		SampleMass = 0.002
		size = 6724								// long lab analysis for the sample.
		value = 16								//nerfed value (24->16). Removed biome mask for flying high. (i doubt the atmo has biome specific composition that high up)
		duration = 18							//quick experiment, but it's a sample, therefore requires lab analysis. the analysis will be long.
	}

	asteroidSample								//this is somewhat irrelevant, as the only change that takes effect right now is size and value. rest needs to be figured out properly.
	{
		//ECCost = 14.83
		//SampleMass = 0.018
		size = 1694								//// long lab analysis for the sample.
		value = 70								//biome should be irrelevant, asteroids don't have biomes, and flying above a planet's biome should also be irrelevant for the sample.
		//duration = 75
	}

	infraredTelescope
	{
		ECCost = 1.91
		size = 4289386462						//humongous data scale, reasons below.
		value = 440								//20 times the value (reason below),unchanged situation/biome mask. limited to kerbin high orbit only.
		duration = 230083200					// 25. yes. 25. (years if it's unclear) - reason - hubble has been operating for close to 30 years at this point, and still provides invaluable data. This should serve the same function in ksp
	}

	kerbalism_Crew1								//2 week crew report, landed/splashed biome mask.
	{
		ECCost = 5.18
		size = 2359
		value = 15								// starting value.
		duration = 302400						// 2 weeks crew report, minimum crew: 2
	}

	kerbalism_Crew2								//ultra long term, 2+years, landed, for ground bases. no biomes
	{
		ECCost = 3.14
		size = 19824
		value = 250								// starting value.
		duration = 21954240						//long duration, 2y+, ground bases only. (landed/splashed). not kerbin. minimum crew: 3, minimum space: 35m3 per kerbal.
	}

	FLOAT										//6 months Kerbin SOI Habitation,4 crew minimum, 50m3 per kerbal. have fun.
	{
		ECCost = 5.82
		size = 1428
		value = 75								// starting value.
		duration = 3888000						// 6 months. preparation for interplanetary manned travel. Kerbin, Mun, Minmus
	}

	LEAVE										//Orbital habitation around other bodies, 1y+, 6 crew minimum.
	{
		ECCost = 17.94
		size = 3398
		value = 120								// starting value.
		duration = 11102400						//1y+
	}

	kerbalism_Ground1							// no clue, 6m+, landed only, no biomes, not kerbin, engineer@3 required. why? because.
	{
		ECCost = 27.53
		size = 18205
		value = 75								// starting value.
		duration = 4838400						// 7-ish months
	}

	kerbalism_Ground2							//again, no clue, 1y+, landed/splashed only, biomes, minimum crew: 4
	{
		ECCost = 9.37
		size = 13482
		value = 148								// starting value.
		duration = 11664000						//1y+
	}
}


// ============================================================================
// Replacing stock experiments with our own, one by one.
// Affects all parts that use both the stock module AND stock experiments.
// ============================================================================
@PART[*]:HAS[@MODULE[ModuleScienceExperiment]:HAS[#experimentID[atmosphereAnalysis]]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	!MODULE[ModuleScienceExperiment]:HAS[#experimentID[atmosphereAnalysis]]	{}
	MODULE
	{
		name = Experiment
		experiment_id = atmosphereAnalysis
	}
}
@PART[*]:HAS[@MODULE[ModuleScienceExperiment]:HAS[#experimentID[mysteryGoo]]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	!MODULE[ModuleScienceExperiment]:HAS[#experimentID[mysteryGoo]]	{}
	MODULE
	{
		name = Experiment
		experiment_id = mysteryGoo
	}
}
@PART[*]:HAS[@MODULE[ModuleScienceExperiment]:HAS[#experimentID[mobileMaterialsLab]]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	!MODULE[ModuleScienceExperiment]:HAS[#experimentID[mobileMaterialsLab]]	{}
	MODULE
	{
		name = Experiment
		experiment_id = mobileMaterialsLab
	}
}
@PART[*]:HAS[@MODULE[ModuleScienceExperiment]:HAS[#experimentID[seismicScan]]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	!MODULE[ModuleScienceExperiment]:HAS[#experimentID[seismicScan]]	{}
	MODULE
	{
		name = Experiment
		experiment_id = seismicScan
	}
}
@PART[*]:HAS[@MODULE[ModuleScienceExperiment]:HAS[#experimentID[barometerScan]]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	!MODULE[ModuleScienceExperiment]:HAS[#experimentID[barometerScan]]	{}
	MODULE
	{
		name = Experiment
		experiment_id = barometerScan
	}
}
@PART[*]:HAS[@MODULE[ModuleScienceExperiment]:HAS[#experimentID[gravityScan]]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	!MODULE[ModuleScienceExperiment]:HAS[#experimentID[gravityScan]]	{}
	MODULE
	{
		name = Experiment
		experiment_id = gravityScan
	}
}
@PART[*]:HAS[@MODULE[ModuleScienceExperiment]:HAS[#experimentID[temperatureScan]]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	!MODULE[ModuleScienceExperiment]:HAS[#experimentID[temperatureScan]]	{}
	MODULE
	{
		name = Experiment
		experiment_id = temperatureScan
	}
}
@PART[*]:HAS[@MODULE[ModuleScienceExperiment]:HAS[#experimentID[infraredTelescope]]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	!MODULE[ModuleScienceExperiment]:HAS[#experimentID[infraredTelescope]]	{}
	MODULE
	{
		name = Experiment
		experiment_id = infraredTelescope
	}
}
@PART[kerbalEVA*]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	!MODULE[ModuleScienceExperiment]:HAS[#experimentID[surfaceSample]]	{}
	!MODULE[ModuleScienceExperiment]:HAS[#experimentID[evaReport]]		{}
	MODULE
	{
		name = Experiment
		experiment_id = surfaceSample
	}
	MODULE
	{
		name = Experiment
		experiment_id = evaReport
	}
}
// @PART[*]:HAS[@MODULE[ModuleScienceExperiment]:HAS[#experimentID[asteroidSample]]]:NEEDS[FeatureScience]:FOR[Kerbalism]					//needs proper implementation before this can be replaced.
// {
	// !MODULE[ModuleScienceExperiment]:HAS[#experimentID[asteroidSample]]	{}
	// MODULE
	// {
		// name = Experiment
		// experiment_id = asteroidSample
	// }
// }
@PART[*]:HAS[@MODULE[ModuleScienceExperiment]:HAS[#experimentID[crewReport]]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	!MODULE[ModuleScienceExperiment]:HAS[#experimentID[crewReport]]	{}
	MODULE
	{
		name = Experiment
		experiment_id = crewReport
	}
}
@PART[*]:HAS[@MODULE[ModuleScienceExperiment]:HAS[#experimentID[geigerCounter]]]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	!MODULE[ModuleScienceExperiment]:HAS[#experimentID[geigerCounter]]	{}
	MODULE
	{
		name = Experiment
		experiment_id = geigerCounter
	}
}
// ============================================================================
// Reconfigure stock experiments(avoiding a global nuke to keep people happy)
// strongly recommendeded to not change anything in this section
// Separate from above due to Configure Groups.
// ============================================================================
@PART[*]:HAS[@MODULE[Experiment]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@MODULE[Experiment]:HAS[#experiment_id[crewReport]]
	{
		%experiment_description = A brief situation report of dubious relevance and accuracy.
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/crewReport/ECCost$
		%crew_operate = True
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/crewReport/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/crewReport/duration$
	}

	@MODULE[Experiment]:HAS[#experiment_id[surfaceSample]]
	{
		%sample_collecting = True
		%sample_reservoir = 0
		%requires = Surface
		%sample_mass = #$@KERBALISM_EXPERIMENT_VALUES/surfaceSample/SampleMass$
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/surfaceSample/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/surfaceSample/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/surfaceSample/duration$
	}

	@MODULE[Experiment]:HAS[#experiment_id[evaReport]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/evaReport/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/evaReport/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/evaReport/duration$
		%crew_operate = True
	}

	@MODULE[Experiment]:HAS[#experiment_id[mysteryGoo]]
	{
		%experiment_description = Goo trapped in a container so that it won't run away
		%sample_mass = #$@KERBALISM_EXPERIMENT_VALUES/mysteryGoo/SampleMass$
		%sample_reservoir = #$sample_mass$
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/mysteryGoo/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/mysteryGoo/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/mysteryGoo/duration$
		UPGRADES
		{
			UPGRADE
			{
				name__ = Goo-Storage-Upgrade
				techRequired__ = #$../../../@KERBALISM_HDD_SIZES/PRIVATE_DRIVES/MysteryGoo/UpgradeTech$
				sample_reservoir = #$../../#sample_reservoir$
				@sample_reservoir *= #$../../../@KERBALISM_HDD_SIZES/PRIVATE_DRIVES/MysteryGoo/SampleReservoirUpgrade$
			}
		}

	}

	@MODULE[Experiment]:HAS[#experiment_id[mobileMaterialsLab]]
	{
		%sample_mass = #$@KERBALISM_EXPERIMENT_VALUES/mobileMaterialsLab/SampleMass$
		%sample_reservoir = #$sample_mass$
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/mobileMaterialsLab/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/mobileMaterialsLab/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/mobileMaterialsLab/duration$
		UPGRADES
		{
			UPGRADE
			{
				name__ = MatBay-Storage-Upgrade
				techRequired__ = #$../../../@KERBALISM_HDD_SIZES/PRIVATE_DRIVES/MaterialsBay/UpgradeTech$
				sample_reservoir = #$../../#sample_reservoir$
				@sample_reservoir *= #$../../../@KERBALISM_HDD_SIZES/PRIVATE_DRIVES/MaterialsBay/SampleReservoirUpgrade$
			}
		}
	}

	@MODULE[Experiment]:HAS[#experiment_id[temperatureScan]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/temperatureScan/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/temperatureScan/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/temperatureScan/duration$
	}

	@MODULE[Experiment]:HAS[#experiment_id[barometerScan]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/barometerScan/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/barometerScan/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/barometerScan/duration$
	}

	@MODULE[Experiment]:HAS[#experiment_id[seismicScan]]
	{
		%requires = Surface
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/seismicScan/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/seismicScan/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/seismicScan/duration$
	}

	@MODULE[Experiment]:HAS[#experiment_id[gravityScan]]
	{
		%requires = Microgravity
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/gravityScan/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/gravityScan/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/gravityScan/duration$
	}

	@MODULE[Experiment]:HAS[#experiment_id[atmosphereAnalysis]]
	{
		%requires = Atmosphere
		%sample_collecting = True
		%sample_reservoir = 0
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/atmosphereAnalysis/ECCost$
		%sample_mass = #$@KERBALISM_EXPERIMENT_VALUES/atmosphereAnalysis/SampleMass$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/atmosphereAnalysis/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/atmosphereAnalysis/duration$
	}

	// @MODULE[Experiment]:HAS[#experiment_id[asteroidSample]]											//needs proper implementation before this can work.
	// {
		// %sample_collecting = True
		// %sample_mass = #$@KERBALISM_EXPERIMENT_VALUES/asteroidSample/SampleMass$
		// %sample_reservoir = 0
		// %ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/asteroidSample/ECCost$
		// %data_rate = #$@KERBALISM_EXPERIMENT_VALUES/asteroidSample/size$
		// @data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/asteroidSample/duration$
		// %requires = MaxAsteroidDistance:100
	// }

	@MODULE[Experiment]:HAS[#experiment_id[infraredTelescope]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/infraredTelescope/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/infraredTelescope/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/infraredTelescope/duration$
		%requires = Body:Kerbin
	}

	@MODULE[Experiment]:HAS[#experiment_id[geigerCounter]]
	{
		%experiment_desc = Let's look at the radiation levels out there.
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/geigerCounter/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/geigerCounter/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/geigerCounter/duration$
	}

	@MODULE[Experiment]:HAS[#experiment_id[kerbalism_Crew1]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Crew1/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Crew1/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Crew1/duration$
		%crew_operate = True
		%requires = CrewMin:2,AstronautComplexLevelMin:2,AdministrationLevelMin:2,MissionControlLevelMin:2
	}

	@MODULE[Experiment]:HAS[#experiment_id[kerbalism_Crew2]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Crew2/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Crew2/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Crew2/duration$
		%crew_operate = True
		%requires = CrewMin:3,Body:!Kerbin,VolumePerCrewMin:35,TrackingStationLevelMin:2
	}

	@MODULE[Experiment]:HAS[#experiment_id[kerbalism_FLOAT]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/FLOAT/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/FLOAT/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/FLOAT/duration$
		%crew_operate = True
		%requires = CrewMin:4,Body:Kerbin;Mun;Minmus,VolumePerCrewMin:50,OrbitMaxEccentricity:0.02
	}

	@MODULE[Experiment]:HAS[#experiment_id[kerbalism_LEAVE]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/LEAVE/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/LEAVE/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/LEAVE/duration$
		%crew_operate = True
		%requires = CrewMin:6,Body:!Kerbin;!Mun;!Minmus,Space,OrbitMinEccentricity:0.3,OrbitMinInclination:35,OrbitMaxInclination:55
	}

	@MODULE[Experiment]:HAS[#experiment_id[kerbalism_Ground1]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Ground1/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Ground1/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Ground1/duration$
		%crew_operate = Engineer@4
		%requires = AstronautComplexLevelMin:3,AdministrationLevelMin:2,MissionControlLevelMin:3,RadiationMin:0.02,Surface,Body:!Kerbin
	}

	@MODULE[Experiment]:HAS[#experiment_id[kerbalism_Ground2]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Ground2/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Ground2/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Ground2/duration$
		%crew_operate = True
		%requires = AstronautComplexLevelMin:3,MissionControlLevelMin:3,CrewMin:4,VolumePerCrewMin:20,Body:!Kerbin
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[surfaceSample]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/surfaceSample/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/surfaceSample/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[crewReport]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/crewReport/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/crewReport/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[evaReport]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/evaReport/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/evaReport/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[mysteryGoo]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/mysteryGoo/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/mysteryGoo/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[mobileMaterialsLab]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/mobileMaterialsLab/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/mobileMaterialsLab/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[temperatureScan]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/temperatureScan/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/temperatureScan/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[barometerScan]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/barometerScan/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/barometerScan/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[seismicScan]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/seismicScan/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/seismicScan/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[gravityScan]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/gravityScan/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/gravityScan/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[atmosphereAnalysis]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/atmosphereAnalysis/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/atmosphereAnalysis/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[asteroidSample]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/asteroidSample/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/asteroidSample/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[infraredTelescope]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/infraredTelescope/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/infraredTelescope/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[geigerCounter]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/geigerCounter/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/geigerCounter/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[kerbalism_Crew1]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Crew1/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Crew1/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[kerbalism_Crew2]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Crew2/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Crew2/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[kerbalism_FLOAT]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/FLOAT/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/FLOAT/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[kerbalism_LEAVE]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/LEAVE/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/LEAVE/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[kerbalism_Ground1]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Ground1/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Ground1/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[kerbalism_Ground2]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Ground2/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/kerbalism_Ground2/size$
	@dataScale /= #$baseValue$
}
// ============================================================================
// Animation fix for goo container & materials bay
// ============================================================================
@PART[GooExperiment,science_module]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	!MODULE[ModuleAnimateGeneric]		{}
	@MODULE[Experiment]
	{
		%anim_deploy = Deploy
	}
}
// ============================================================================
// Nerfing EC cost for EVA kerbals for surface sample, otherwise it's unuseable
// Done this way because of groups that include the surface sample.
// ============================================================================
@PART[kerbalEVA*]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@MODULE[Experiment]:HAS[#experiment_id[surfaceSample]]
	{
		@ec_rate /= 100
	}
}
// ============================================================================
// Tweak some stock experiment parameters.
// ============================================================================

@EXPERIMENT_DEFINITION:HAS[#id[surfaceSample]]:NEEDS[FeatureScience]:FOR[Kerbalism]    		{	@situationMask = 1
																								@biomeMask = 1								}
@EXPERIMENT_DEFINITION:HAS[#id[crewReport]]:NEEDS[FeatureScience]:FOR[Kerbalism]      		{	@biomeMask = 3 								}
@EXPERIMENT_DEFINITION:HAS[#id[evaReport]]:NEEDS[FeatureScience]:FOR[Kerbalism]    			{	@situationMask = 51
																								@biomeMask = 3								}
@EXPERIMENT_DEFINITION:HAS[#id[mysteryGoo]]:NEEDS[FeatureScience]:FOR[Kerbalism]    		{	@biomeMask = 0
																								@title = Goo Observation					}
@EXPERIMENT_DEFINITION:HAS[#id[mobileMaterialsLab]]:NEEDS[FeatureScience]:FOR[Kerbalism]    {	@biomeMask = 0 								}
@EXPERIMENT_DEFINITION:HAS[#id[gravityScan]]:NEEDS[FeatureScience]:FOR[Kerbalism]      		{	@biomeMask = 3 								}
@EXPERIMENT_DEFINITION:HAS[#id[atmosphereAnalysis]]:NEEDS[FeatureScience]:FOR[Kerbalism]  	{	@biomeMask = 5
																								@title = Atmospheric Composition Sample		}
@EXPERIMENT_DEFINITION:HAS[#id[geigerCounter]]:NEEDS[FeatureScience]:FOR[Kerbalism]       	{	@biomeMask = 3 								}
@EXPERIMENT_DEFINITION:HAS[#id[barometerScan]]:NEEDS[FeatureScience]:FOR[Kerbalism]       	{	@title = Pressure Scan
																								@requireAtmosphere = True
																								@situationMask = 15
																								@biomeMask = 7								}
// @EXPERIMENT_DEFINITION:HAS[#id[asteroidSample]]:NEEDS[FeatureScience]:FOR[Kerbalism]      	{	@title = Asteroid Scan 									//needs proper implementation before this cna be patched
		//																						@biomeMask = 0								}


// ============================================================================
// Remove scientist bonus
// ============================================================================

@EXPERIENCE_TRAIT[Scientist]:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	@desc = Scientists can reset experiments.
	@EFFECT[VesselScienceReturn] { @modifiers = 1, 1, 1, 1, 1 }
	@EFFECT[PartScienceReturn]   { @modifiers = 1, 1, 1, 1, 1 }
}

// ============================================================================
// Lab module satisfies stock contracts
// ============================================================================

@Contracts:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	@Base
	{
		@PART_REQUEST:HAS[#Module[ModuleScienceLab]] { @Module = Laboratory }
	}
	@Station
	{
		@PART_REQUEST:HAS[#Module[ModuleScienceLab]] { @Module = Laboratory }
	}
}

// ============================================================================
// Remove stock survey contracts
// ============================================================================

@Contracts:NEEDS[FeatureScience]:FOR[Kerbalism]
{
	@Survey
	{
		@MaximumAvailable = 0
		@MaximumActive = 0
	}
}

// ============================================================================
// Replace stock lab with our own
// Labs are special snowflakes: they sample data twice as fast at 5 times the EC
// cost and bypass the need for experiment resets, but they require a scientist
// present at all times to operate. Scientist level configured below.
// Only affects the Laboratory Experiments Group.
// Also triples sample reservoir, for good measure.
// Labs get a selection of exclusive experiments + the ability to run Goo & MatBay
// ============================================================================
@PART[*]:HAS[@MODULE[ModuleScienceLab]]:NEEDS[FeatureScience]
{
	!MODULE[ModuleScienceLab] {}
	!MODULE[ModuleScienceConverter] {}

	MODULE
	{
		name = Laboratory
		researcher = Scientist
		analysis_rate = 0.005 // 5 kbps
		ec_rate = 1.0
	}

	MODULE
	{
		name = Configure
		title = Laboratory Experiments
		slots = 0
	}
}
@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]]:NEEDS[FeatureScience]:AFTER[Kerbalism]
{
	@MODULE[Experiment],*
	{
		@data_rate *= 2
		@ec_rate *= 5
		%crew_operate = Scientist
		!crew_reset = dummyvalue
	}

	//per experiment tweaks, also boosts sample reservoirs where appropriate
	@MODULE[Experiment]:HAS[#experiment_id[mysteryGoo]] 			{ 	%crew_operate = Scientist@1
																		@sample_reservoir *= 3
																		@UPGRADES	{	@UPGRADE {	@sample_reservoir = #$../../#sample_reservoir$
																									@sample_reservoir *= 5								}}}
	@MODULE[Experiment]:HAS[#experiment_id[mobileMaterialsLab]] 	{ 	%crew_operate = Scientist@2
																		@sample_reservoir *= 3
																		@UPGRADES	{	@UPGRADE {	@sample_reservoir = #$../../#sample_reservoir$
																									@sample_reservoir *= 3								}}}
}

// ============================================================================
//adds sensors to gravioli/radiation/temperature/pressure to all parts that use
//the stock experiments and do not already have one.
// ============================================================================

@PART[*]:HAS[!MODULE[Sensor],@MODULE[Experiment]:HAS[#experiment_id[geigerCounter]]]:NEEDS[FeatureScience]:FOR[zzzKerbalism]
{
	MODULE
	{
		name = Sensor
		type = radiation
	}
}
@PART[*]:HAS[!MODULE[Sensor],@MODULE[Experiment]:HAS[#experiment_id[gravityScan]]]:NEEDS[FeatureScience]:FOR[zzzKerbalism]
{
	MODULE
	{
		name = Sensor
		type = gravioli
	}
}
@PART[*]:HAS[!MODULE[Sensor],@MODULE[Experiment]:HAS[#experiment_id[temperatureScan]]]:NEEDS[FeatureScience]:FOR[zzzKerbalism]
{
	MODULE
	{
		name = Sensor
		type = temperature
	}
}
@PART[*]:HAS[!MODULE[Sensor],@MODULE[Experiment]:HAS[#experiment_id[sensorBarometer]]]:NEEDS[FeatureScience]:FOR[zzzKerbalism]
{
	MODULE
	{
		name = Sensor
		type = pressure
	}
}
